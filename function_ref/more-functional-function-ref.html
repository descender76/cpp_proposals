<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>A More Functional function_ref</title>
  <meta name="description" content="A More Functional function_ref">
  <meta name="author" content="Jarrad Waterloo">
  <style>
    h1
	{
	  text-align : center;
	}
	.code
	{
	  background-color: AliceBlue;
	}
	table.inline_references
	{
		border: 1px solid black;
		border-collapse: collapse;
	}
	table.inline_references > thead > tr > th
	{
		border: 1px solid black;
	}
	table.inline_references > tbody > tr > td
	{
		border: 1px solid black;
	}
	/*
	*/
  </style>
</head>
<body>
<h1>A More Functional function_ref</h1>
<table style="width:100%">
<tr>
<td>&nbsp;</td>
<td style="width:60ex">
  <table>
  <tr>
  <td><b>Document #:</b></td><td>PTODOR0</td>
  </tr>
  <tr>
  <td><b>Date:</b></td><td>2021-07-30</td>
  </tr>
  <tr>
  <td><b>Project:</b></td><td>Programming Language C++</td>
  </tr>
  <tr>
  <td><b>Audience:</b></td><td>Library Evolution Working Group (LEWG)</td>
  </tr>
  <tr>
  <td><b>Reply-to:</b></td><td>Jarrad J. Waterloo<br/>&lt;<a href="mailto:descender76@gmail.com">descender76@gmail.com</a>&gt;</td>
  </tr>
  </table>
</td>
</tr>
</table>
<h2>Contents</h2>
<!--
<h3><a href="#revision_history">1&nbsp;&nbsp;Revision History</a></h3>
-->
<h3><a href="#introduction">1&nbsp;&nbsp;Introduction</a></h3>
<h3><a href="#prior_work">2&nbsp;&nbsp;Prior Work</a></h3>
<h3><a href="#history">3&nbsp;&nbsp;History</a></h3>
<h3><a href="#fall_short">4&nbsp;&nbsp;Where does function_ref fall short?</a></h3>
<h3><a href="#alternate_realities">5&nbsp;&nbsp;Solutions &amp; Alternate Realities</a></h3>
<!--
<h3><a href="#motivation_scope">2&nbsp;&nbsp;Motivation and Scope</a></h3>
<h3><a href="#before_after">3&nbsp;&nbsp;Before/After Comparisons</a></h3>
<h3><a href="#overview">4&nbsp;&nbsp;Design Overview</a></h3>
<h3><a href="#wording">5&nbsp;&nbsp;Proposed Wording</a></h3>
<h3><a href="#design">7&nbsp;&nbsp;Design Decisions</a></h3>
-->
<h3><a href="#performance">6&nbsp;&nbsp;Runtime Performance</a></h3>
<!--
<h3><a href="#examples">9&nbsp;&nbsp;Examples</a></h3>
<h3><a href="#future">10&nbsp;Future Work</a></h3>
<h3><a href="#acknowledgements">11&nbsp;Acknowledgements</a></h3>
-->
<h3><a href="#references">7&nbsp;&nbsp;References</a></h3>
<!--
<h2 id="revision_history">Revision History</h2>
<p>TODO</p>
-->
<h2 id="introduction">Introduction</h2>
<p>There are many types of runtime polymorphism each with their PRO's and CON's. These range from single function callbacks to classes with multiple virtual member functions and even those with multiple type erased parameters. Even though C gives us callbacks via function pointers and C++ adds to our support of runtime polymorphism via its virtual functions, their is still considerable interest in other types of runtime polymorphism, as illustrated by just some of the proposals in past years.</p>
<table class="inline_references">
<thead>
<tr>
<th>Document Date</th>
<th>WG21 Number</th>
<th>Title</th>
<th>Author</th>
</tr>
</thead>
<tr>
<td>2017-02-06</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0288r1.pdf">P0288R1</a></td>
<td>A polymorphic wrapper for all Callable objects</td>
<td>David Krauss</td>
</tr>
<tr>
<td><i>2017-06-07</i></td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0312r1.html"><i>P0312R1</i></a></td>
<td><i>Make Pointers to Members Callable</i></td>
<td><i>Barry Revzin</i></td>
</tr>
<tr>
<td>2017-10-16</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0201r2.pdf">P0201R2</a></td>
<td>A polymorphic value-type for C++</td>
<td>Jonathan Coe</td>
</tr>
<tr>
<td><b>2017-10-10</b></td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0792r0.html"><b>P0792R0</b></a></td>
<td><b>function_ref: a non-owning reference to a Callable</b></td>
<td><b>Vittorio Romeo</b></td>
</tr>
<td>2018-02-12</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0201r3.pdf">P0201R3</a></td>
<td>A polymorphic value-type for C++</td>
<td>Jonathan Coe, Sean Parent</td>
</tr>
<tr>
<td><b>2017-11-26</b></td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0792r1.html"><b>P0792R1</b></a></td>
<td><b>function_ref: a non-owning reference to a Callable</b></td>
<td><b>Vittorio Romeo</b></td>
</tr>
<tr>
<td>2018-02-12</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0957r0.pdf">P0957R0</a></td>
<td>PFA: A Generic, Extendable and Efficient Solution for Polymorphic Programming</td>
<td>Mingxin Wang</td>
</tr>
<tr>
<td><i>2018-04-01</i></td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0984r0.pdf"><i>P0984R0</i></a></td>
<td><i>All (*)()-Pointers Replaced by Ideal Lambdas</i></td>
<td><i>Peter Sommerlad</i></td>
</tr>
<tr>
<td><b>2018-05-06</b></td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0792r2.html"><b>P0792R2</b></a></td>
<td><b>function_ref: a non-owning reference to a Callable</b></td>
<td><b>Vittorio Romeo</b></td>
</tr>
<tr>
<td>2018-04-18</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0957r1.pdf">P0957R1</a></td>
<td>PFA: A Generic, Extendable and Efficient Solution for Polymorphic Programming</td>
<td>Mingxin Wang</td>
</tr>
<tr>
<td>2018-10-05</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0201r4.pdf">P0201R4</a></td>
<td>A polymorphic value-type for C++</td>
<td>Jonathan Coe, Sean Parent</td>
</tr>
<tr>
<td><b>2018-10-07</b></td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0792r3.html"><b>P0792R3</b></a></td>
<td><b>function_ref: a non-owning reference to a Callable</b></td>
<td><b>Vittorio Romeo</b></td>
</tr>
<tr>
<td><i>2018-10-06</i></td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p1214r0.html"><i>P1214R0</i></a></td>
<td><i>Pointer to Member Functions and Member Objects are just Callables!</i></td>
<td><i>JeanHeyd Meneide</i></td>
</tr>
<td>2019-03-11</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0201r5.html">P0201R5</a></td>
<td>A polymorphic value-type for C++</td>
<td>Jonathan Coe, Sean Parent</td>
</tr>
<tr>
<td><b>2019-06-17</b></td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0792r4.html"><b>P0792R4</b></a></td>
<td><b>function_ref: a non-owning reference to a Callable</b></td>
<td><b>Vittorio Romeo</b></td>
</tr>
<tr>
<td>2019-06-17</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0957r2.pdf">P0957R2</a></td>
<td>PFA: A Generic, Extendable and Efficient Solution for Polymorphic Programming</td>
<td>Mingxin Wang</td>
</tr>
<tr>
<td>2019-06-17</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p1678r0.pdf">P1678R0</a></td>
<td>Callbacks and Composition</td>
<td>Kirk Shoop</td>
</tr>
<tr>
<td>2019-08-05</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p1678r1.pdf"></a>P1678R1</td>
<td>Callbacks and Composition</td>
<td>Kirk Shoop</td>
</tr>
<tr>
<td>2019-10-07</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0288r5.html">P0288R5</a></td>
<td>any_invocable</td>
<td>Matt Calabrese, Ryan McDougall</td>
</tr>
<tr>
<td><b>2019-10-06</b></td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0792r5.html"><b>P0792R5</b></a></td>
<td><b>function_ref: a non-owning reference to a Callable</b></td>
<td><b>Vittorio Romeo</b></td>
</tr>
<tr>
<td>2019-10-07</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0957r3.pdf">P0957R3</a></td>
<td>PFA: A Generic, Extendable and Efficient Solution for Polymorphic Programming</td>
<td>Mingxin Wang</td>
</tr>
<tr>
<td>2019-10-06</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p1678r2.pdf">P1678R2</a></td>
<td>Callbacks and Composition</td>
<td>Kirk Shoop</td>
</tr>
<tr>
<td>2019-11-23</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0957r4.pdf">P0957R4</a></td>
<td>PFA: A Generic, Extendable and Efficient Solution for Polymorphic Programming</td>
<td>Mingxin Wang</td>
</tr>
<tr>
<td>2020-03-04</td>
<td><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/p2123r0.html">P2123R0</a></td>
<td>interfaces: A Facility to Manage ABI/API Evolution</td>
<td>Hal Finkel, Tom Scogland</td>
</tr>
</table>
<p>One such is the single function callback as proposed in the <a href="#reference-p0792r5">function_ref</a> proposals. Upon closer examination, function_ref has some serious limitations and does not handle a common use case. In order to better understand these limitations and the common use case we need to examine callbacks historically and the prior work of others.<s> ... boostcon polymorphism PRO's ... single method special case ... wikipedia multimethods ... RUST traits ... GO interfaces ... callbacks/delegates</s></p>
<del>
<p>bifurcation</p>
</del>
<h2 id="prior_work">Prior Work</h2>
<p><a href="#reference-p0792r5">function_ref</a> is most like <a href="#reference-cpp-pointer-declaration-function">C function pointers</a>. In the following modified <a href="#reference-cpp-pointer-declaration-function">cppreference</a> example, int_return_int is  the type of function pointer that points to function that takes and returns an int.</p>
<!-- snippet-function-pointer-simple.cc.html -->
<div class="code">
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;iostream&gt;</font>

<i><font color="#9A1900">// type declaration to function pointer</font></i>
<b><font color="#0000FF">typedef</font></b> <font color="#009900">int</font> <font color="#990000">(*</font>int_return_int<font color="#990000">)(</font><font color="#009900">int</font><font color="#990000">);</font>

<font color="#009900">int</font> <b><font color="#000000">f</font></b><font color="#990000">(</font><font color="#009900">int</font> n<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> n <font color="#990000">*</font> n<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// function pointers can be passed to functions</font></i>
<font color="#009900">int</font> <b><font color="#000000">g</font></b><font color="#990000">(</font><font color="#008080">int_return_int</font> callback<font color="#990000">,</font> <font color="#009900">int</font> value<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">callback</font></b><font color="#990000">(</font>value<font color="#990000">);</font>
<font color="#FF0000">}</font>

<font color="#008080">int_return_int</font> <b><font color="#000000">h</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
    <i><font color="#9A1900">// function pointers can be returned from functions</font></i>
    <b><font color="#0000FF">return</font></b> f<font color="#990000">;</font>
<font color="#FF0000">}</font>
 
<font color="#009900">int</font> <b><font color="#000000">main</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
    <font color="#008080">int_return_int</font> p <font color="#990000">=</font> f<font color="#990000">;</font>
    p <font color="#990000">=</font> <font color="#990000">&amp;</font>f<font color="#990000">;</font>
    p <font color="#990000">=</font> <b><font color="#000000">h</font></b><font color="#990000">();</font>
    std<font color="#990000">::</font>cout <font color="#990000">&lt;&lt;</font> <b><font color="#000000">p</font></b><font color="#990000">(</font><font color="#993399">7</font><font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font><font color="#990000">;</font><i><font color="#9A1900">// 49</font></i>
    std<font color="#990000">::</font>cout <font color="#990000">&lt;&lt;</font> <b><font color="#000000">g</font></b><font color="#990000">(</font>p<font color="#990000">,</font> <font color="#993399">9</font><font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font><font color="#990000">;</font><i><font color="#9A1900">// 81</font></i>
<font color="#FF0000">}</font></tt></pre>
</div>
<p>While C function pointers are generally useful they can be temporarily limiting because the behavior of the provided function varies on the parameters passed by the caller of function pointer and not by the provider of the function. This limit is surpassed with a little bit of colaboration between the caller and callee of the function by making a slight modification to the function pointer type contract that they agree to. Adding a void* to the parameter list of function pointer allows the provider of the function to be called to provide type erased state to influence the desired behavior of the function, provided of course the caller passes this state along.</p>
<!-- snippet-function-pointer-complex.cc.html -->
<div class="code">
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;iostream&gt;</font>

<i><font color="#9A1900">// type declaration to function pointer</font></i>
<b><font color="#0000FF">typedef</font></b> <font color="#009900">int</font> <font color="#990000">(*</font>int_return_int<font color="#990000">)(</font><font color="#009900">void</font><font color="#990000">*</font> userdata<font color="#990000">,</font> <font color="#009900">int</font><font color="#990000">);</font>

<font color="#009900">int</font> <b><font color="#000000">f</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">*</font> userdata<font color="#990000">,</font> <font color="#009900">int</font> n<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <font color="#990000">*((</font><font color="#009900">int</font><font color="#990000">*)</font>userdata<font color="#990000">)</font> <font color="#990000">*</font> n<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// function pointers can be passed to functions</font></i>
<font color="#009900">int</font> <b><font color="#000000">g</font></b><font color="#990000">(</font><font color="#008080">int_return_int</font> callback<font color="#990000">,</font> <font color="#009900">void</font><font color="#990000">*</font> userdata<font color="#990000">,</font> <font color="#009900">int</font> value<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">callback</font></b><font color="#990000">(</font>userdata<font color="#990000">,</font> value<font color="#990000">);</font>
<font color="#FF0000">}</font>

<font color="#008080">int_return_int</font> <b><font color="#000000">h</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
    <i><font color="#9A1900">// function pointers can be returned from functions</font></i>
    <b><font color="#0000FF">return</font></b> f<font color="#990000">;</font>
<font color="#FF0000">}</font>
 
<font color="#009900">int</font> <b><font color="#000000">main</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
    <font color="#009900">int</font> userdata <font color="#990000">=</font> <font color="#993399">4</font><font color="#990000">;</font>
    <font color="#008080">int_return_int</font> p <font color="#990000">=</font> f<font color="#990000">;</font>
    p <font color="#990000">=</font> <font color="#990000">&amp;</font>f<font color="#990000">;</font>
    p <font color="#990000">=</font> <b><font color="#000000">h</font></b><font color="#990000">();</font>
    std<font color="#990000">::</font>cout <font color="#990000">&lt;&lt;</font> <b><font color="#000000">p</font></b><font color="#990000">(&amp;</font>userdata<font color="#990000">,</font> <font color="#993399">7</font><font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font><font color="#990000">;</font><i><font color="#9A1900">// 28</font></i>
    std<font color="#990000">::</font>cout <font color="#990000">&lt;&lt;</font> <b><font color="#000000">g</font></b><font color="#990000">(</font>p<font color="#990000">,</font> <font color="#990000">&amp;</font>userdata<font color="#990000">,</font> <font color="#993399">9</font><font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font><font color="#990000">;</font><i><font color="#9A1900">// 36</font></i>
<font color="#FF0000">}</font></tt></pre>
</div>
<p>Taking it a step forward the function pointer and the type erased user data can be combined since they are tightly related.</p>
<!-- snippet-function-pointer-struct.cc.html -->
<div class="code">
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;iostream&gt;</font>

<i><font color="#9A1900">// type declaration to function pointer</font></i>
<b><font color="#0000FF">typedef</font></b> <font color="#009900">int</font> <font color="#990000">(*</font>int_return_int<font color="#990000">)(</font><font color="#009900">void</font><font color="#990000">*</font> userdata<font color="#990000">,</font> <font color="#009900">int</font><font color="#990000">);</font>

<b><font color="#0000FF">struct</font></b> <font color="#008080">closure_delegate</font>
<font color="#FF0000">{</font>
    <font color="#008080">int_return_int</font> callback<font color="#990000">;</font>
    <font color="#009900">void</font><font color="#990000">*</font> userdata<font color="#990000">;</font>
<font color="#FF0000">}</font><font color="#990000">;</font>

<i><font color="#9A1900">// call operator to make it convenient to call the callback</font></i>
<font color="#009900">int</font> <b><font color="#000000">closure_delegate_execute</font></b><font color="#990000">(</font><font color="#008080">closure_delegate</font> cd<font color="#990000">,</font> <font color="#009900">int</font> value<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> cd<font color="#990000">.</font><b><font color="#000000">callback</font></b><font color="#990000">(</font>cd<font color="#990000">.</font>userdata<font color="#990000">,</font> value<font color="#990000">);</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// constructor to make it convenient to create a callback</font></i>
<font color="#008080">closure_delegate</font> <b><font color="#000000">closure_delegate_bind_to_int</font></b><font color="#990000">(</font><font color="#008080">int_return_int</font> callback<font color="#990000">,</font> <font color="#009900">int</font><font color="#990000">*</font> userdata<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <font color="#FF0000">{</font>callback<font color="#990000">,</font> userdata<font color="#FF0000">}</font><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// the function to be called polymorphically</font></i>
<font color="#009900">int</font> <b><font color="#000000">f</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">*</font> userdata<font color="#990000">,</font> <font color="#009900">int</font> n<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <font color="#990000">*((</font><font color="#009900">int</font><font color="#990000">*)</font>userdata<font color="#990000">)</font> <font color="#990000">*</font> n<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">int</font> <b><font color="#000000">main</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<font color="#009900">int</font> userdata <font color="#990000">=</font> <font color="#993399">2</font><font color="#990000">;</font>
    <font color="#008080">closure_delegate</font> cd <font color="#990000">=</font> <b><font color="#000000">closure_delegate_bind_to_int</font></b><font color="#990000">(</font>f<font color="#990000">,</font> <font color="#990000">&amp;</font>userdata<font color="#990000">);</font>
    std<font color="#990000">::</font>cout <font color="#990000">&lt;&lt;</font> <b><font color="#000000">closure_delegate_execute</font></b><font color="#990000">(</font>cd<font color="#990000">,</font> <font color="#993399">7</font><font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font><font color="#990000">;</font><i><font color="#9A1900">// 14</font></i>
    std<font color="#990000">::</font>cout <font color="#990000">&lt;&lt;</font> <b><font color="#000000">closure_delegate_execute</font></b><font color="#990000">(</font>cd<font color="#990000">,</font> <font color="#993399">9</font><font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">'</font><font color="#CC33CC">\n</font><font color="#FF0000">'</font><font color="#990000">;</font><i><font color="#9A1900">// 18</font></i>
<font color="#FF0000">}</font></tt></pre>
</div>
<p>Interesting this is comparable to how <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0792r5.html#cb9-6" target="__blank">function_ref</a> was designed and/or implemented.</p>
<!-- snippet-function_ref-private.cc.html -->
<div class="code">
<pre><tt><b><font color="#0000FF">namespace</font></b> std
<font color="#FF0000">{</font>
    <b><font color="#0000FF">template</font></b> <font color="#990000">&lt;</font><b><font color="#0000FF">typename</font></b> <font color="#008080">Signature</font><font color="#990000">&gt;</font>
    <b><font color="#0000FF">class</font></b> <font color="#008080">function_ref</font>
    <font color="#FF0000">{</font>
        <font color="#009900">void</font><font color="#990000">*</font> erased_object<font color="#990000">;</font> <i><font color="#9A1900">// exposition only</font></i>

        <b><font color="#000000">R</font></b><font color="#990000">(*</font>erased_function<font color="#990000">)(</font>Args<font color="#990000">...);</font> <i><font color="#9A1900">// exposition only</font></i>
        <i><font color="#9A1900">// `R`, and `Args...` are the return type, and the parameter-type-list,</font></i>
        <i><font color="#9A1900">// of the function type `Signature`, respectively.</font></i>

        <i><font color="#9A1900">// ...</font></i>
    <font color="#FF0000">}</font><font color="#990000">;</font>

    <i><font color="#9A1900">// ...</font></i>
<font color="#FF0000">}</font></tt></pre>
</div>
<!-- snippet-function_ref-constructor.cc.html -->
<div class="code">
<pre><tt><b><font color="#0000FF">namespace</font></b> std
<font color="#FF0000">{</font>
    <b><font color="#0000FF">template</font></b> <font color="#990000">&lt;</font><b><font color="#0000FF">typename</font></b> <font color="#008080">Signature</font><font color="#990000">&gt;</font>
    <b><font color="#0000FF">class</font></b> <font color="#008080">function_ref</font>
    <font color="#FF0000">{</font>
        <i><font color="#9A1900">// ...</font></i>

    <b><font color="#0000FF">public</font></b><font color="#990000">:</font>
        <b><font color="#000000">function_ref</font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> function_ref<font color="#990000">&amp;)</font> <b><font color="#0000FF">noexcept</font></b> <font color="#990000">=</font> <b><font color="#0000FF">default</font></b><font color="#990000">;</font>

        <b><font color="#0000FF">template</font></b> <font color="#990000">&lt;</font><b><font color="#0000FF">typename</font></b> <font color="#008080">F</font><font color="#990000">&gt;</font>
        <b><font color="#000000">function_ref</font></b><font color="#990000">(</font>F<font color="#990000">&amp;&amp;);</font>

        <i><font color="#9A1900">// ...</font></i>
    <font color="#FF0000">}</font><font color="#990000">;</font>

    <i><font color="#9A1900">// ...</font></i>
<font color="#FF0000">}</font></tt></pre>
</div>
<!-- snippet-function_ref-constructors.cc.html -->
<div class="code">
<pre><tt><i><font color="#9A1900">// https://github.com/TartanLlama/function_ref/blob/master/tests/constructors.cpp</font></i>
<i><font color="#9A1900">// ...</font></i>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;tl/function_ref.hpp&gt;</font>

<font color="#009900">void</font> <b><font color="#000000">foo</font></b><font color="#990000">()</font><font color="#FF0000">{}</font>
<b><font color="#0000FF">struct</font></b> <font color="#008080">bar</font> <font color="#FF0000">{</font>
    <font color="#009900">void</font> <b><font color="#000000">baz</font></b><font color="#990000">()</font><font color="#FF0000">{}</font>
<font color="#FF0000">}</font><font color="#990000">;</font>

<i><font color="#9A1900">// ...</font></i>
    tl<font color="#990000">::</font><font color="#008080">function_ref&lt;void(void)&gt;</font> fr1 <font color="#990000">=</font> <font color="#990000">[]</font><font color="#FF0000">{}</font><font color="#990000">;</font>
    tl<font color="#990000">::</font><font color="#008080">function_ref&lt;void(void)&gt;</font> fr2 <font color="#990000">=</font> foo<font color="#990000">;</font>
    tl<font color="#990000">::</font><font color="#008080">function_ref&lt;void(bar)&gt;</font> fr3 <font color="#990000">=</font> <font color="#990000">&amp;</font>bar<font color="#990000">::</font>baz<font color="#990000">;</font>

    <i><font color="#9A1900">// ...</font></i></tt></pre>
</div>
<!-- snippet-__closure.cc.html -->
<div class="code">
<pre><tt><i><font color="#9A1900">// http://docwiki.embarcadero.com/RADStudio/Sydney/en/Closure</font></i>

<b><font color="#0000FF">class</font></b> <font color="#008080">something</font> <font color="#FF0000">{</font>
<b><font color="#0000FF">public</font></b><font color="#990000">:</font>
    <font color="#009900">int</font> <b><font color="#000000">func</font></b><font color="#990000">(</font><font color="#009900">int</font> x<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
    <font color="#FF0000">}</font><font color="#990000">;</font>
<font color="#FF0000">}</font><font color="#990000">;</font>

<font color="#009900">int</font> <b><font color="#000000">main</font></b><font color="#990000">(</font><font color="#009900">int</font> argc<font color="#990000">,</font> <font color="#009900">char</font> <font color="#990000">*</font> argv<font color="#990000">[])</font> <font color="#FF0000">{</font>
    <font color="#008080">something</font> s<font color="#990000">;</font>
    <font color="#009900">void</font><font color="#990000">(</font>__closure <font color="#990000">*</font> c<font color="#990000">)(</font><font color="#009900">int</font><font color="#990000">);</font>

    c <font color="#990000">=</font> s<font color="#990000">.</font>func<font color="#990000">;</font>
    <b><font color="#000000">c</font></b><font color="#990000">(</font><font color="#993399">3</font><font color="#990000">);</font>

    <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#FF0000">}</font></tt></pre>
</div>
<!-- snippet-delegate.cc.html -->
<div class="code">
<pre><tt><i><font color="#9A1900">// https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/delegates/using-delegates</font></i>

delegate <font color="#008080">int</font> <b><font color="#000000">int_return_int</font></b><font color="#990000">(</font><font color="#009900">int</font><font color="#990000">);</font>

<b><font color="#0000FF">class</font></b> <font color="#008080">something</font> <font color="#FF0000">{</font>
<b><font color="#0000FF">public</font></b><font color="#990000">:</font>
    <font color="#009900">int</font> <b><font color="#000000">func</font></b><font color="#990000">(</font><font color="#009900">int</font> x<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
    <font color="#FF0000">}</font><font color="#990000">;</font>
<font color="#FF0000">}</font><font color="#990000">;</font>

<font color="#009900">int</font> <b><font color="#000000">main</font></b><font color="#990000">(</font><font color="#009900">int</font> argc<font color="#990000">,</font> <font color="#009900">char</font> <font color="#990000">*</font> argv<font color="#990000">[])</font> <font color="#FF0000">{</font>
    <font color="#008080">something</font> s<font color="#990000">;</font>

    <font color="#008080">int_return_int</font> c <font color="#990000">=</font> s<font color="#990000">.</font>func<font color="#990000">;</font>
    <b><font color="#000000">c</font></b><font color="#990000">(</font><font color="#993399">3</font><font color="#990000">);</font>

    <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#FF0000">}</font></tt></pre>
</div>
<p>__closure</p>
<p>C# delegate</p>
<h2 id="history">History</h2>
<p>C++ NOT C ... bifurcation ... swiss cheese ... ?increased binding one has to do?</p>
<h2 id="fall_short">Where does function_ref fall short?</h2>
<p>member functions -&gt; double indirection  -&gt; more difficult to use having to reason about more temporaries</p>
<h2 id="alternate_realities">Solutions &amp; Alternate Realities</h2>
<p>reduce encapsulation by exposing inner pointers for construction</p>
<p>add typesafe versions of constructor even though a make function</p>
<p>add make function for member functions</p>
<p>add make function for other callable constructs such as constructors, operators, destructors</p>
<p>little language support via a compiler function traits to provide minimal language support for the method type erasure</p>
<p>major language upport as a language feature</p>
<h2 id="performance">Runtime Performance</h2>
<p>Things must first work than get optimized.</p>
<p>Brief mention of code project.</p>
<p>Contrast C implementation versus C++ implementation</p>
<p>...</p>
<p>...</p>
<p>...</p>
<s>
<p>It should be noted that is neither the motivation nor the scope of the current <a href="#reference-p1371r2">pattern matching proposal</a> to provide any mechanisms for error handling. However, there are two parts of the pattern matching proposal that has a bearing on error handling.</p>
<p>The first one starts in section 4.4 Matching Variants. So if the return of a function is a variant of the expected value and the unexpected error code or object than the pattern matching proposal can be used to perform error handling.</p>
<!-- snippet.return-based.00.cc -->
<pre class="code"><tt><font color="#008080">variant&lt;rete, error_code&gt;</font> <b><font color="#000000">e</font></b><font color="#990000">()</font> <b><font color="#0000FF">noexcept</font></b><font color="#990000">;</font>
<font color="#008080">variant&lt;reto, error_object&gt;</font> <b><font color="#000000">o</font></b><font color="#990000">()</font> <b><font color="#0000FF">noexcept</font></b><font color="#990000">;</font>

<font color="#008080">variant&lt;rete, error_code&gt;</font> temp1 <font color="#990000">=</font> <b><font color="#000000">e</font></b><font color="#990000">();</font>
<b><font color="#000000">inspect</font></b><font color="#990000">(</font>temp1<font color="#990000">)</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>rete<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>error_code<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font>
<font color="#008080">variant&lt;reto, error_object&gt;</font> temp2 <font color="#990000">=</font> <b><font color="#000000">o</font></b><font color="#990000">();</font>
<b><font color="#000000">inspect</font></b><font color="#990000">(</font>temp2<font color="#990000">)</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>reto<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>error_object<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font></tt></pre>
<p>The second is that while in most of the examples in the pattern matching proposal the <i>init-statement<sub>opt</sub> condition</i> appears to be a variable it can also be a function call. The one example of this is found in 5.3.2.7 Extractor Pattern: Example "inspect (f()) {". The previous example can be simplified further by removing the temporary variables.</p>
<!-- snippet.return-based.01.cc -->
<pre class="code"><tt><font color="#008080">variant&lt;rete, error_code&gt;</font> <b><font color="#000000">e</font></b><font color="#990000">()</font> <b><font color="#0000FF">noexcept</font></b><font color="#990000">;</font>
<font color="#008080">variant&lt;reto, error_object&gt;</font> <b><font color="#000000">o</font></b><font color="#990000">()</font> <b><font color="#0000FF">noexcept</font></b><font color="#990000">;</font>

<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">e</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>rete<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>error_code<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font>
<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">o</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>reto<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>error_object<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font></tt></pre>
<p>The pattern matching proposal has excellent support for return based error handling. What does exception handling look like with the current pattern matching proposal?</p>
<!-- snippet.exception-based.00.cc -->
<pre class="code"><tt><font color="#008080">reta</font> <b><font color="#000000">a</font></b><font color="#990000">();</font><i><font color="#9A1900">// throws b, c, d</font></i>

<b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
	<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">a</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
		<font color="#990000">&lt;</font>reta<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>b<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>c<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>d<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font></tt></pre>
<p>In other words, pattern matching has no support for exception based error handling. Worse, by indirectly favoring one type of error handling over the other it is widening the rift between return based and exception based error handling. Even worse still, it is favoring return based over the exception based; the non standard over the standard. Ideally, it would be a much more pleasant error handling experience if the exception handlers could be moved inside with the inspect handlers.</p>
<!-- snippet.exception-based.01.cc -->
<pre class="code"><tt><font color="#008080">reta</font> <b><font color="#000000">a</font></b><font color="#990000">();</font><i><font color="#9A1900">// throws b, c, d</font></i>

<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">a</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>reta<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>b<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>c<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>d<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font></tt></pre>
<p>The value of the conciseness of this request becomes more visually apparent when even more error handling is performed in close proximity. This is especially true when using 3rd party modules and their transitive dependencies. All of which can vary in how errors are produced. See the more complicated example in the next section.</p>
<h2 id="before_after">Before/After Comparisons</h2>
<b>Given</b>
<pre class="code"><tt><font color="#008080">reta</font> <b><font color="#000000">a</font></b><font color="#990000">();</font><i><font color="#9A1900">// throws b, c, d</font></i>
<font color="#008080">variant&lt;rete, error_code&gt;</font> <b><font color="#000000">e</font></b><font color="#990000">()</font> <b><font color="#0000FF">noexcept</font></b><font color="#990000">;</font>
<font color="#008080">reti</font> <b><font color="#000000">i</font></b><font color="#990000">();</font><i><font color="#9A1900">// throws f, g, h</font></i>
<font color="#008080">variant&lt;reto, error_object&gt;</font> <b><font color="#000000">o</font></b><font color="#990000">()</font> <b><font color="#0000FF">noexcept</font></b><font color="#990000">;</font>
<font color="#008080">retu</font> <b><font color="#000000">u</font></b><font color="#990000">();</font><i><font color="#9A1900">// throws j, k, l</font></i>
</tt></pre>
<hr/>
<table style="width:100%">
<tr>
<td style="width:50%;text-align:center">
<b>Before</b>
</td>
<td style="width:50%;text-align:center">
<b>After</b>
</td>
</tr>
</table>
<hr/>
<table style="width:100%">
<tr>
<td class="code" style="width:50%">
<pre><tt><b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
	<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">a</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
		<font color="#990000">&lt;</font>reta<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>b<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>c<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>d<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font>
<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">e</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>retb<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>error_code<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font>
<b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
	<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">i</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
		<font color="#990000">&lt;</font>reti<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>f<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>g<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>h<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font>
<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">o</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>reto<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>error_object<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font>
<b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
	<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">u</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
		<font color="#990000">&lt;</font>retu<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>j<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>k<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b><font color="#990000">(</font>l<font color="#990000">)</font> <font color="#FF0000">{</font>
<font color="#FF0000">}</font>
</tt></pre>
</td>
<td class="code" style="width:50%">
<pre><tt><b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">a</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>reta<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>b<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>c<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>d<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font>
<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">e</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>rete<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>error_code<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font>
<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">i</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>reti<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>f<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>g<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>h<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font>
<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">o</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>reto<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>error_object<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font>
<b><font color="#000000">inspect</font></b><font color="#990000">(</font><b><font color="#000000">u</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
	<font color="#990000">&lt;</font>retu<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>j<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>k<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
	<font color="#990000">&lt;</font>l<font color="#990000">&gt;</font> <i><font color="#9A1900">//...</font></i>
<font color="#FF0000">}</font></tt></pre>
</td>
</tr>
</table>
<h2 id="overview">Design Overview</h2>
<p><b>What are the advantages to allowing inspect to catch exceptions?</b><br/>
<ol>
<li>inspect won't widen the error handling bifurcation</li>
<li>inspect won't widen the error handling bifurcation in favor of the less standard return based over the more standard exception based</li>
<li>programmers can use a single mechanism to handle return based and exception based error handling at the statement level</li>
<li>other than for performance reasons, the need to create dual error handling API's is diminished because the consumer can handle it the same way</li>
</ol>
</p>
<p><b>NOTE:</b> If it makes it any easier to implement the desired functionality, the <i>init-statement<sub>opt</sub> condition</i> could be limited to a single function call, "inspect(a()) {", instead of a coumpound call such as "inspect(a() + e() - i() * o() / u()) {". This would be ok from a usability stand point because the programmer could always wrap the more complicated expression into a lamda.</p>
<p><b>Wouldn't we need some syntax to differentiate a type that could be both returned and thrown?</b><br/>NO. Exceptions typically are derived from the exception base class and are thrown not returned. Returns tend to be error_code or something else which is not derived from exception. Accounting for a rarely used same type in both context scenarios would greatly diminish the majority case as a whole. The whole point of this syntax is the developer in statement based error handling doesn't need to know how the function/expression in question produced the error. Further this fringe outlier can easily be resolved by the implementer of said function. It is much easier for a library writer to refrain from a fringe case than to resort to providing dual interfaces.</p>
<p>
<b>"How would we deal with the N+1 problem? Frequently new syntax is introduced as way to get rid of an older syntax, but frequently what happens is that we end up with the new syntax and the old syntax." (source unknown)</b><br/>
The current pattern matching proposal has already added new syntax which replaces in some circumstances if and switch. This proposal doesn't so much invent a new systax as it removes a perceived limitation or restriction. While some may think this revision puts inspect in competition with try/catch, I assure it doesn't. It is actually complementary. Try/Catch is block based. Return based error handling as well as pattern matching's inspect is statement based. Block based error handling is ideal when dealing with blocks. Statement based error handling is ideal when dealing with statements. Which one the programmer uses depends on the situation at the moment of need! A situation may have try/catch as a catch all for a whole function block. However in that same function, a specific function call is required to handle the error at the moment of the call due to business requirements of the error handling occurring before some other statement. At that moment, programmers reach for a statement based tool even though there is some catch handler catching everything else. I believe there is a misconception that for dual API's programmer's reach for eirther exception or return based API calls. However if your code base uses both than you are more likely to use both.
</p>
<h2 id="wording">Proposed Wording</h2>
<p>If the <i>init-statement<sub>opt</sub> condition</i> can throw an exception, then exceptions can be caught by inspect's <i>alternative-pattern</i>.</p>
</s>
<!--
<h2 id="design">Design Decisions</h2>
<p>TODO</p>
<h2 id="performance">Runtime Performance</h2>
<p>TODO</p>
<h2 id="examples">Examples</h2>
<p>TODO</p>
<h2 id="future">Future Work</h2>
<p>TODO</p>
<h2 id="acknowledgements">Acknowledgements</h2>
<p>TODO</p>
-->
<h2 id="references">References</h2>
<span id="reference-p0792r0">[P0792R0] function_ref: a non-owning reference to a Callable</span><br/>
&nbsp;&nbsp;&nbsp;<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0792r0.html" target="__blank">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0792r0.html</a><br/>
<br/>
<span id="reference-p0792r1">[P0792R1] function_ref: a non-owning reference to a Callable</span><br/>
&nbsp;&nbsp;&nbsp;<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0792r1.html" target="__blank">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0792r1.html</a><br/>
<br/>
<span id="reference-p0792r2">[P0792R2] function_ref: a non-owning reference to a Callable</span><br/>
&nbsp;&nbsp;&nbsp;<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0792r2.html" target="__blank">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0792r2.html</a><br/>
<br/>
<span id="reference-p0792r3">[P0792R3] function_ref: a non-owning reference to a Callable</span><br/>
&nbsp;&nbsp;&nbsp;<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0792r3.html" target="__blank">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0792r3.html</a><br/>
<br/>
<span id="reference-p0792r4">[P0792R4] function_ref: a non-owning reference to a Callable</span><br/>
&nbsp;&nbsp;&nbsp;<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0792r4.html" target="__blank">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0792r4.html</a><br/>
<br/>
<span id="reference-p0792r5">[P0792R5] function_ref: a non-owning reference to a Callable</span><br/>
&nbsp;&nbsp;&nbsp;<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0792r5.html" target="__blank">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p0792r5.html</a><br/>
<br/>
<span id="reference-cpp-pointer-declaration-function">cppreference.com ... Pointer declaration ... Pointers to functions</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://en.cppreference.com/w/cpp/language/pointer#Pointers_to_functions" target="__blank">https://en.cppreference.com/w/cpp/language/pointer#Pointers_to_functions</a><br/>
<br/>
<span id="reference-harder">Implementing function_view is harder than you might think</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://www.foonathan.net/2017/01/function-ref-implementation/" target="__blank">https://www.foonathan.net/2017/01/function-ref-implementation/</a><br/>
<br/>
<span id="reference-p1371r2">What is a “callback” in C and how are they implemented?</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://stackoverflow.com/questions/142789/what-is-a-callback-in-c-and-how-are-they-implemented" target="__blank">https://stackoverflow.com/questions/142789/what-is-a-callback-in-c-and-how-are-they-implemented</a><br/>
<br/>
<span id="reference-p1371r2">Using A C++ Object’s Member Function with C-style Callbacks</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://embeddedartistry.com/blog/2017/07/10/using-a-c-objects-member-function-with-c-style-callbacks/" target="__blank">https://embeddedartistry.com/blog/2017/07/10/using-a-c-objects-member-function-with-c-style-callbacks/</a><br/>
<br/>
<span id="reference-p1371r2">Callback (computer programming)</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://en.wikipedia.org/wiki/Callback_(computer_programming)" target="__blank">https://en.wikipedia.org/wiki/Callback_(computer_programming)</a><br/>
<br/>
<span id="reference-p1371r2">Function object</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://en.wikipedia.org/wiki/Function_object" target="__blank">https://en.wikipedia.org/wiki/Function_object</a><br/>
<br/>
<span id="reference-p1371r2">__closure</span><br/>
&nbsp;&nbsp;&nbsp;<a href="http://docwiki.embarcadero.com/RADStudio/Sydney/en/Closure" target="__blank">http://docwiki.embarcadero.com/RADStudio/Sydney/en/Closure</a><br/>
<br/>
<span id="reference-p1371r2">C++ Delegates and Borland's C++ Builder Event Handling - Part I</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://www.codeproject.com/Articles/44874/C-Delegates-and-Borland-s-C-Builder-Event-Handling" target="__blank">https://www.codeproject.com/Articles/44874/C-Delegates-and-Borland-s-C-Builder-Event-Handling</a><br/>
<br/>
<span id="reference-p1371r2">Delegates (C# Programming Guide)</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/delegates/" target="__blank">https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/delegates/</a><br/>
<br/>
<span id="reference-p1371r2">Using Delegates (C# Programming Guide)</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/delegates/using-delegates" target="__blank">https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/delegates/using-delegates</a><br/>
<br/>
<span id="reference-p1371r2">The Impossibly Fast C++ Delegates</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://www.codeproject.com/Articles/11015/The-Impossibly-Fast-C-Delegates" target="__blank">https://www.codeproject.com/Articles/11015/The-Impossibly-Fast-C-Delegates</a><br/>
<br/>
<span id="reference-p1371r2">Member Function Pointers and the Fastest Possible C++ Delegates</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://www.codeproject.com/Articles/7150/Member-Function-Pointers-and-the-Fastest-Possible" target="__blank">https://www.codeproject.com/Articles/7150/Member-Function-Pointers-and-the-Fastest-Possible</a><br/>
<br/>
<span id="reference-p1371r2">function_ref</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://github.com/TartanLlama/function_ref" target="__blank">https://github.com/TartanLlama/function_ref</a><br/>
<br/>
<span id="reference-p1371r2">On function_ref and string_view</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://quuxplusone.github.io/blog/2019/05/10/function-ref-vs-string-view/" target="__blank">https://quuxplusone.github.io/blog/2019/05/10/function-ref-vs-string-view/</a><br/>
<br/>
<span id="reference-p1371r2">How to pass and execute anonymous function as parameter in C++11?</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://newbedev.com/how-to-pass-and-execute-anonymous-function-as-parameter-in-c-11" target="__blank">https://newbedev.com/how-to-pass-and-execute-anonymous-function-as-parameter-in-c-11</a><br/>
<br/>
<span id="reference-p1371r2">Passing Functions to Functions in C++</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://tech.jocodoma.com/2019/02/27/Passing-Functions-to-Functions-in-CPP/" target="__blank">https://tech.jocodoma.com/2019/02/27/Passing-Functions-to-Functions-in-CPP/</a><br/>
<br/>
<span id="reference-p1371r2">passing functions to functions</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://vittorioromeo.info/index/blog/passing_functions_to_functions.html">https://vittorioromeo.info/index/blog/passing_functions_to_functions.html</a><br/>
<br/>
<span id="reference-p1371r2">function_view: a non-owning reference to a Callable</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://vittorioromeo.info/Misc/fnview0.html" target="__blank">https://vittorioromeo.info/Misc/fnview0.html</a><br/>
<br/>
<span id="reference-p1371r2">Alternative to std::function for passing function as argument (callbacks, etc.)</span><br/>
&nbsp;&nbsp;&nbsp;<a href="https://stackoverflow.com/questions/39087141/alternative-to-stdfunction-for-passing-function-as-argument-callbacks-etc" target="__blank">https://stackoverflow.com/questions/39087141/alternative-to-stdfunction-for-passing-function-as-argument-callbacks-etc</a><br/>
<br/>
<span id="reference-p1371r2">Packs outside of Templates</span><br/>
&nbsp;&nbsp;&nbsp;<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2277r0.html" target="__blank">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2021/p2277r0.html</a><br/>
<br/>
<span id="reference-p1371r2">A type trait to detect reference binding to temporary</span><br/>
&nbsp;&nbsp;&nbsp;<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/p2255r0.html" target="__blank">http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/p2255r0.html</a><br/>
<!--
function_ref
http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/p0792r0.html
http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0792r2.html
https://www.foonathan.net/2017/01/function-ref-implementation/
All that is just a lot of implementation hassle that is simply not worth it, especially with lambdas. If you want a member function, just use a lambda:

Prior Work
C function pointer and void pointer callback
https://stackoverflow.com/questions/142789/what-is-a-callback-in-c-and-how-are-they-implemented
void *userdata
...
struct event_cb {
    event_cb_t cb;
    void *data;
};
https://embeddedartistry.com/blog/2017/07/10/using-a-c-objects-member-function-with-c-style-callbacks/
converting member function into regular function
https://en.wikipedia.org/wiki/Callback_(computer_programming)
https://en.wikipedia.org/wiki/Function_object

Borland C++ Closure
http://docwiki.embarcadero.com/RADStudio/Sydney/en/Closure
https://www.codeproject.com/Articles/44874/C-Delegates-and-Borland-s-C-Builder-Event-Handling
// https://stackoverflow.com/questions/27769401/borland-style-closure-in-gcc

C# delegate
https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/delegates/
https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/delegates/using-delegates

Code Project
https://www.codeproject.com/Articles/11015/The-Impossibly-Fast-C-Delegates
https://www.codeproject.com/Articles/7150/Member-Function-Pointers-and-the-Fastest-Possible

Other function_ref assessments
https://github.com/TartanLlama/function_ref
https://quuxplusone.github.io/blog/2019/05/10/function-ref-vs-string-view/
https://newbedev.com/how-to-pass-and-execute-anonymous-function-as-parameter-in-c-11
https://tech.jocodoma.com/2019/02/27/Passing-Functions-to-Functions-in-CPP/
https://vittorioromeo.info/index/blog/passing_functions_to_functions.html
https://stackoverflow.com/questions/39087141/alternative-to-stdfunction-for-passing-function-as-argument-callbacks-etc/39087660#39087660
https://vittorioromeo.info/Misc/fnview0.html
https://www.foonathan.net/2017/01/function-ref-implementation/
"just use a lambda"
The example provided does not type erase the this pointer.
https://stackoverflow.com/questions/39087141/alternative-to-stdfunction-for-passing-function-as-argument-callbacks-etc

CON
existing requires double indirection, another lifetime programmer has to manage

WHY
like C function pointer in C NOT C++ binds to anything VS. C++ swiss cheese

REQUESTS
language support
AND/OR
factories for common cases
AND/OR
implementation detail void constructor
AND/OR
implementation detail template T constructor
AND/OR
constructor template parameters
AND/OR
alias of type lists and parameter packs
-->
</body>
</html>
